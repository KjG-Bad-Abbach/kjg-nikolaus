<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KjG Nikolaus Buchung</title>
    <link href="{{ mix('/css/app.css') }}" rel="stylesheet" />
    <script defer src="{{ mix('/js/app.js') }}"></script>
  </head>
  <body
    class="bg-java my-4 flex min-h-screen flex-col items-center justify-center"
  >
    <!-- Main Container -->
    <div
      class="mx-auto w-full max-w-3xl text-center"
      x-data="bookingForm"
      data-testid="qa-booking-root"
      x-init="updateCanEdit(); setInterval(() => updateCanEdit(), 1000)"
    >
      <h1 class="text-calypso mx-2 mb-4 text-4xl font-bold">
        KjG Nikolaus Buchung
      </h1>

      <p class="text-calypso mx-2 text-lg">
        Buche deinen persönlichen Nikolausbesuch mit der KjG Bad Abbach!
      </p>

      <!-- Introduction Text -->
      <div
        x-show="view === 'intro'"
        data-testid="qa-view-intro"
        class="mx-2 my-8 space-y-6 rounded-lg bg-white p-6 text-left shadow-md"
        x-cloak
      >
        <div id="introduction-text"></div>

        <div class="text-center">
          <button
            @click="view = 'steps'"
            data-testid="qa-intro-start"
            class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 rounded-sm px-6 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
          >
            Jetzt anmelden
          </button>
        </div>
      </div>

      <!-- Deadlines -->
      <div class="text-calypso mx-2 mt-4" data-testid="qa-deadlines">
        <p class="font-bold">Wichtige Termine:</p>
        <p
          :class="canEditRoutePlanning ? '' : 'line-through text-calypso-700'"
          data-testid="qa-deadline-route-planning"
        >
          Adresse und Zeitslots:
          <span
            x-text="formatDateTime(options.route_planning_deadline)"
            class="font-semibold"
          ></span>
          <span class="text-sm">(wichtig für Routenplanung)</span>
        </p>
        <p
          :class="canEditAnything ? '' : 'line-through text-calypso-700'"
          data-testid="qa-deadline-final"
        >
          Finale Deadline:
          <span
            x-text="formatDateTime(options.final_deadline)"
            class="font-semibold"
          ></span>
          <span class="text-sm">(für alle restlichen Angaben)</span>
        </p>
      </div>

      <!-- Loading Spinner -->
      <div
        x-show="isLoading"
        data-testid="qa-loading"
        class="my-8 flex items-center justify-center"
        x-cloak
      >
        <div class="text-calypso h-12 w-12 animate-spin">
          <svg
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            data-slot="icon"
          >
            <path
              clip-rule="evenodd"
              fill-rule="evenodd"
              d="M4.755 10.059a7.5 7.5 0 0 1 12.548-3.364l1.903 1.903h-3.183a.75.75 0 1 0 0 1.5h4.992a.75.75 0 0 0 .75-.75V4.356a.75.75 0 0 0-1.5 0v3.18l-1.9-1.9A9 9 0 0 0 3.306 9.67a.75.75 0 1 0 1.45.388Zm15.408 3.352a.75.75 0 0 0-.919.53 7.5 7.5 0 0 1-12.548 3.364l-1.902-1.903h3.183a.75.75 0 0 0 0-1.5H2.984a.75.75 0 0 0-.75.75v4.992a.75.75 0 0 0 1.5 0v-3.18l1.9 1.9a9 9 0 0 0 15.059-4.035.75.75 0 0 0-.53-.918Z"
            ></path>
          </svg>
        </div>
      </div>

      <!-- View for steps -->
      <div x-show="view === 'steps'" data-testid="qa-view-steps" x-cloak>
        <!-- Show Steps -->
        <div class="mx-2 mt-8 mb-4">
          <h2 class="sr-only">Schritte</h2>

          <div class="flex items-center space-x-2 px-2">
            <!-- Previous Step Button -->
            <button
              x-show="canJumpToAnyStep"
              @click="step > 0 ? setStep(step - 1) : null"
              class="text-calypso focus:ring-java-500 focus:ring-opacity-50 flex-none cursor-pointer py-2 font-bold select-none focus:ring-2 focus:outline-hidden"
              :class="step <= 0 ? 'opacity-50 cursor-not-allowed' : 'hover:text-calypso-950'"
              :disabled="step <= 0"
              aria-hidden="true"
              aria-label="Vorheriger Schritt"
              title="Vorheriger Schritt"
              x-cloak
            >
              <svg
                class="size-8"
                fill="currentColor"
                viewBox="0 0 16 16"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
                data-slot="icon"
              >
                <path
                  clip-rule="evenodd"
                  fill-rule="evenodd"
                  d="M14 8a.75.75 0 0 1-.75.75H4.56l3.22 3.22a.75.75 0 1 1-1.06 1.06l-4.5-4.5a.75.75 0 0 1 0-1.06l4.5-4.5a.75.75 0 0 1 1.06 1.06L4.56 7.25h8.69A.75.75 0 0 1 14 8Z"
                ></path>
              </svg>
            </button>

            <!-- Step Progress Bar -->
            <div
              class="after:bg-java-500 relative grow after:absolute after:inset-x-0 after:top-1/2 after:block after:h-0.5 after:-translate-y-1/2 after:rounded-lg"
            >
              <ol
                data-testid="qa-stepper"
                class="text-calypso relative z-10 flex justify-between text-sm font-medium"
              >
                <!-- Loop through the steps -->
                <template x-for="(x, index) in steps" :key="index">
                  <li
                    x-on:click="setStep(index)"
                    :data-testid="'qa-step-' + x.testId"
                    :class="canJumpToAnyStep || step === index ? 'hover:text-calypso-950 cursor-pointer' : 'cursor-not-allowed'"
                    class="group bg-java flex items-center gap-1 p-1 select-none"
                    :title="x.name"
                  >
                    <span
                      class="size-8 rounded-full border-4 text-center text-[10px]/6 font-bold"
                      :class="
                        (
                          x.allFilled || step === index
                            ? (
                              'bg-calypso' + (
                                canJumpToAnyStep || step === index
                                  ? ' group-hover:bg-calypso-950'
                                  : ''
                              ) + ' text-calypso-500'
                            )
                          : 'bg-java-500'
                        ) + (
                          step === index
                            ? ' border-calypso-950'
                            : ' border-java'
                        )
                      "
                    >
                      <span
                        x-show="!x.allFilled"
                        x-text="index + 1"
                        x-cloak
                      ></span>
                      <span x-show="x.allFilled" x-cloak>
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="m-1 size-4"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      </span>
                    </span>
                    <span class="hidden sm:block" x-text="x.name"></span>
                  </li>
                </template>
              </ol>
            </div>

            <!-- Next Step Button -->
            <button
              x-show="canJumpToAnyStep"
              @click="step < steps.length - 1 ? setStep(step + 1) : null"
              class="text-calypso focus:ring-java-500 focus:ring-opacity-50 flex-none cursor-pointer py-2 font-bold select-none focus:ring-2 focus:outline-hidden"
              :class="step >= steps.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:text-calypso-950'"
              :disabled="step >= steps.length - 1"
              aria-hidden="true"
              aria-label="Nächster Schritt"
              title="Nächster Schritt"
              x-cloak
            >
              <svg
                class="size-8"
                fill="currentColor"
                viewBox="0 0 16 16"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
                data-slot="icon"
              >
                <path
                  clip-rule="evenodd"
                  fill-rule="evenodd"
                  d="M2 8a.75.75 0 0 1 .75-.75h8.69L8.22 4.03a.75.75 0 0 1 1.06-1.06l4.5 4.5a.75.75 0 0 1 0 1.06l-4.5 4.5a.75.75 0 0 1-1.06-1.06l3.22-3.22H2.75A.75.75 0 0 1 2 8Z"
                ></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Show Summary -->
        <div class="mx-4 mb-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
          <!-- Show Contact Details summary -->
          <div
            x-show="(step !== 0 && steps[0].anyFilled) || step === 4"
            class="text-left"
            x-cloak
          >
            <h3 class="text-calypso flex items-center text-lg font-medium">
              <span>Kontaktinformationen</span>
              <span
                class="ml-2 size-6 cursor-pointer"
                x-on:click="setStep(0)"
                title="Bearbeiten"
              >
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z"
                  ></path>
                  <path
                    d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
                  ></path>
                </svg>
              </span>
            </h3>
            <p class="text-gray-700">
              Vorname:
              <span x-text="booking.contact_person?.first_name"></span
              ><span
                x-show="!isFilled(booking.contact_person?.first_name)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span x-text="formatDateTime(options.final_deadline)"></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              Nachname:
              <span x-text="booking.contact_person?.last_name"></span
              ><span
                x-show="!isFilled(booking.contact_person?.last_name)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span x-text="formatDateTime(options.final_deadline)"></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              E-Mail: <span x-text="booking.contact_person?.email"></span
              ><span
                x-show="!isFilled(booking.contact_person?.email)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span x-text="formatDateTime(options.final_deadline)"></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              Telefonnummer:
              <span x-text="booking.contact_person?.phone_number"></span
              ><span
                x-show="!isFilled(booking.contact_person?.phone_number)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span x-text="formatDateTime(options.final_deadline)"></span
                >)</span
              >
            </p>
          </div>

          <!-- Show Address summary -->
          <div
            x-show="(step !== 1 && steps[1].anyFilled) || step === 4"
            class="text-left"
            x-cloak
          >
            <h3 class="text-calypso flex items-center text-lg font-medium">
              <span>Adresse und Ort für Geschenke</span>
              <span
                class="ml-2 size-6 cursor-pointer"
                x-on:click="setStep(1)"
                title="Bearbeiten"
              >
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z"
                  ></path>
                  <path
                    d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
                  ></path>
                </svg>
              </span>
            </h3>
            <p class="text-gray-700">
              Straße: <span x-text="booking.location?.street"></span
              ><span
                x-show="!isFilled(booking.location?.street)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                ></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              Hausnummer:
              <span x-text="booking.location?.house_number"></span
              ><span
                x-show="!isFilled(booking.location?.house_number)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                ></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              PLZ: <span x-text="booking.location?.zip_code"></span
              ><span
                x-show="!isFilled(booking.location?.zip_code)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                ></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              Ort: <span x-text="booking.location?.place"></span
              ><span
                x-show="!isFilled(booking.location?.place)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                ></span
                >)</span
              >
            </p>
            <p class="text-gray-700">
              Ort für Geschenke:
              <span x-text="booking.present_location"></span
              ><span
                x-show="!isFilled(booking.present_location)"
                class="text-rust italic"
                x-cloak
                >(Angabe fehlt, Deadline:
                <span x-text="formatDateTime(options.final_deadline)"></span
                >)</span
              >
            </p>
          </div>

          <!-- Show Time-Slot Selection summary -->
          <div
            x-show="(step !== 2 && steps[2].anyFilled) || step === 4"
            class="text-left"
            x-cloak
          >
            <h3 class="text-calypso flex items-center text-lg font-medium">
              <span>Ausgewählte Zeitslots</span>
              <span
                class="ml-2 size-6 cursor-pointer"
                x-on:click="setStep(2)"
                title="Bearbeiten"
              >
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z"
                  ></path>
                  <path
                    d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
                  ></path>
                </svg>
              </span>
            </h3>
            <ul>
              <template x-for="slotId in selectedTimeSlotIds" :key="slotId">
                <li
                  class="text-gray-700"
                  x-text="availableTimeSlots.find(s => s.id === slotId).label"
                ></li>
              </template>
              <li
                x-show="selectedTimeSlotIds.length === 0"
                class="text-rust italic"
                x-cloak
              >
                (Angabe fehlt, Deadline:
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                ></span
                >)
              </li>
              <li
                x-show="selectedTimeSlotIds.length > 0 && selectedTimeSlotIds.length < options.max_time_slots"
                class="text-rust italic"
                x-cloak
              >
                (Bitte <span x-text="options.max_time_slots"></span> Zeitslots
                auswählen, Deadline:
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                ></span
                >)
              </li>
            </ul>
          </div>

          <!-- Show Children Details summary -->
          <div
            x-show="(step !== 3 && steps[3].anyFilled) || step === 4"
            class="text-left"
            x-cloak
          >
            <h3 class="text-calypso flex items-center text-lg font-medium">
              <span>Kinder</span>
              <span
                class="ml-2 size-6 cursor-pointer"
                x-on:click="setStep(3)"
                title="Bearbeiten"
              >
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z"
                  ></path>
                  <path
                    d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z"
                  ></path>
                </svg>
              </span>
            </h3>
            <ul class="space-y-2">
              <template
                x-for="(child, index) in (booking.children || [])"
                :key="index"
              >
                <li class="flex flex-col text-gray-700">
                  <div>
                    <div class="flex flex-wrap items-baseline gap-1">
                      Name: <span x-text="child.name"></span
                      ><span
                        x-show="!isFilled(child.name)"
                        class="text-rust italic"
                        x-cloak
                        >(Angabe fehlt, Deadline:
                        <span
                          x-text="formatDateTime(options.final_deadline)"
                        ></span
                        >)</span
                      >
                    </div>
                  </div>
                  <div>
                    <div class="flex flex-wrap items-baseline gap-1">
                      Merkmal: <span x-text="child.identification_trait"></span
                      ><span
                        x-show="!isFilled(child.identification_trait)"
                        class="text-rust italic"
                        x-cloak
                        >(Angabe fehlt, Deadline:
                        <span
                          x-text="formatDateTime(options.final_deadline)"
                        ></span
                        >)</span
                      >
                    </div>
                  </div>
                  <div>
                    <div class="flex flex-wrap items-baseline gap-1">
                      <span>Rede:</span>
                      <div class="min-w-0 flex-1">
                        <div class="truncate" x-text="child.speech"></div>
                      </div>
                    </div>
                    <span
                      x-show="!isFilled(child.speech)"
                      class="text-rust italic"
                      x-cloak
                      >(Angabe fehlt, Deadline:
                      <span
                        x-text="formatDateTime(options.final_deadline)"
                      ></span
                      >)</span
                    >
                  </div>
                </li>
              </template>
              <li
                x-show="booking.children.length <= 0"
                class="text-rust italic"
                x-cloak
              >
                (Angabe fehlt, Deadline:
                <span x-text="formatDateTime(options.final_deadline)"></span>)
              </li>
            </ul>
            <div
              x-show="isFilled(booking.additional_notes)"
              class="mt-2 flex flex-wrap items-baseline gap-1 text-gray-700"
              x-cloak
            >
              <span>Hinweise für den Nikolaus:</span>
              <div class="min-w-0 flex-1">
                <div class="truncate" x-text="booking.additional_notes"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 0: Contact Details -->
        <template x-if="step === 0" x-cloak>
          <div
            class="mx-auto w-full max-w-3xl rounded-lg bg-white p-6 shadow-md"
          >
            <h2 class="text-surfie-green mb-4 text-2xl font-bold">
              Kontaktinformationen
            </h2>

            <p class="text-gray-600 italic">
              Hinweis: Deadline für diese Angaben
              <span
                x-text="formatDateTime(options.final_deadline)"
                class="font-semibold"
              ></span
              >.
            </p>
            <p
              x-show="!canEditAnything"
              class="text-rust mb-4 text-sm italic"
              x-cloak
            >
              (Nach der Deadline können die Angaben nicht mehr bearbeitet
              werden)
            </p>

            <form
              data-testid="qa-contact-form"
              class="space-y-6"
              @submit.prevent="submitContactDetails"
            >
              <div>
                <label
                  for="first_name"
                  class="text-surfie-green block text-left font-medium"
                  >Vorname *</label
                >
                <input
                  type="text"
                  id="first_name"
                  data-testid="qa-contact-first-name"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.contact_person.first_name"
                  maxlength="50"
                  placeholder="Vorname"
                  :readonly="!canEditAnything"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.contact_person.first_name'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>

              <div>
                <label
                  for="last_name"
                  class="text-surfie-green block text-left font-medium"
                  >Nachname *</label
                >
                <input
                  type="text"
                  id="last_name"
                  data-testid="qa-contact-last-name"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.contact_person.last_name"
                  maxlength="50"
                  placeholder="Nachname"
                  :readonly="!canEditAnything"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.contact_person.last_name'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>

              <div>
                <label
                  for="email"
                  class="text-surfie-green block text-left font-medium"
                  >E-Mail *</label
                >
                <input
                  type="email"
                  id="email"
                  data-testid="qa-contact-email"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.contact_person.email"
                  maxlength="100"
                  placeholder="example@example.com"
                  :readonly="!canEditAnything"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.contact_person.email'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>

              <div>
                <label
                  for="phone_number"
                  class="text-surfie-green block text-left font-medium"
                  >Telefonnummer *</label
                >
                <input
                  type="tel"
                  id="phone_number"
                  data-testid="qa-contact-phone"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.contact_person.phone_number"
                  maxlength="50"
                  placeholder="0123 4567890"
                  :readonly="!canEditAnything"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.contact_person.phone_number'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>

              <!-- Submit Button -->
              <div x-show="canEditAnything" x-cloak>
                <button
                  type="submit"
                  data-testid="qa-contact-submit"
                  class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 w-full rounded-sm px-4 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
                >
                  Speichern & Weiter
                </button>
                <div
                  x-show="Object.keys(validationMessages).length > 0"
                  class="text-rust mx-2 mt-2 text-left text-sm"
                >
                  Bitte überprüfe deine Eingaben.
                </div>
              </div>
            </form>
          </div>
        </template>

        <!-- Step 1: Address -->
        <template x-if="step === 1" x-cloak>
          <div
            class="mx-auto w-full max-w-3xl rounded-lg bg-white p-6 shadow-md"
          >
            <h2 class="text-surfie-green mb-4 text-2xl font-bold">
              Adresse und Ort für Geschenke
            </h2>

            <p class="text-gray-600 italic">
              Hinweis: Deadline für diese Angaben
              <span
                x-text="formatDateTime(options.route_planning_deadline)"
                class="font-semibold"
              ></span
              >.
            </p>
            <p
              x-show="!canEditRoutePlanning"
              class="text-rust mb-4 text-sm italic"
              x-cloak
            >
              (Nach der Deadline können die Angaben nicht mehr bearbeitet
              werden)
            </p>

            <form
              data-testid="qa-address-form"
              class="space-y-6"
              @submit.prevent="submitAddress"
            >
              <div>
                <label
                  for="street"
                  class="text-surfie-green block text-left font-medium"
                  >Straße *</label
                >
                <input
                  type="text"
                  id="street"
                  data-testid="qa-address-street"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.location.street"
                  maxlength="100"
                  placeholder="Straße"
                  :readonly="!canEditRoutePlanning"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.location.street'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>
              <div>
                <label
                  for="house_number"
                  class="text-surfie-green block text-left font-medium"
                  >Hausnummer *</label
                >
                <input
                  type="text"
                  id="house_number"
                  data-testid="qa-address-house-number"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.location.house_number"
                  maxlength="10"
                  placeholder="Hausnummer"
                  :readonly="!canEditRoutePlanning"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.location.house_number'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>
              <div>
                <label
                  for="zip_code"
                  class="text-surfie-green block text-left font-medium"
                  >PLZ *</label
                >
                <input
                  type="number"
                  id="zip_code"
                  data-testid="qa-address-zip"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.location.zip_code"
                  max="99999"
                  min="00000"
                  placeholder="PLZ"
                  oninput="this.value = this.value.slice(0, 5)"
                  :readonly="!canEditRoutePlanning"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.location.zip_code'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>
              <div>
                <label
                  for="place"
                  class="text-surfie-green block text-left font-medium"
                  >Ort *</label
                >
                <input
                  type="text"
                  id="place"
                  data-testid="qa-address-place"
                  required
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.location.place"
                  maxlength="100"
                  placeholder="Ort"
                  :readonly="!canEditRoutePlanning"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.location.place'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>
              <div>
                <label
                  for="present_location"
                  class="text-surfie-green block text-left font-medium"
                  >Ort für Geschenke</label
                >
                <p class="text-left text-gray-600 italic">
                  Hinweis: Diese Information kann auch später ergänzt werden.
                  Deadline für diese Angabe
                  <span
                    x-text="formatDateTime(options.final_deadline)"
                    class="font-semibold"
                  ></span
                  >.
                </p>
                <div
                  class="mt-2 rounded-md border border-gray-300 bg-gray-50 p-3 text-left text-sm text-gray-700"
                >
                  <p class="font-semibold">Beispiele:</p>
                  <ul class="list-inside list-disc">
                    <li>
                      Geschenke hinter der Papiertonne in der offenen Garage
                    </li>
                    <li>
                      Im Gartenhäuschen hinter dem Haus, der Schlüssel liegt
                      unter dem Blumentopf neben der Tür
                    </li>
                    <li>
                      Geschenke liegen in einem Sack in der Garage links neben
                      dem Eingang
                    </li>
                    <li>
                      Im Carport neben dem Auto, die Geschenke sind in einer
                      roten Tasche mit Weihnachtsmotiv
                    </li>
                  </ul>
                </div>
                <input
                  type="text"
                  id="present_location"
                  data-testid="qa-address-present-location"
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.present_location"
                  maxlength="200"
                  placeholder="Wo können wir die Geschenke finden?"
                  :readonly="!canEditAnything"
                />
                <template
                  x-for="(message, index) in validationMessages['booking.present_location'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>

              <!-- Submit Button -->
              <div x-show="canEditAnything" x-cloak>
                <button
                  type="submit"
                  data-testid="qa-address-submit"
                  class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 w-full rounded-sm px-4 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
                >
                  Speichern & Weiter
                </button>
                <div
                  x-show="Object.keys(validationMessages).length > 0"
                  class="text-rust mx-2 mt-2 text-left text-sm"
                >
                  Bitte überprüfe deine Eingaben.
                </div>
              </div>
            </form>
          </div>
        </template>

        <!-- Step 2: Time-Slot Selection -->
        <template x-if="step === 2" x-cloak>
          <div
            class="mx-auto w-full max-w-3xl rounded-lg bg-white p-6 shadow-md"
          >
            <h2
              x-show="canEditRoutePlanning"
              class="text-surfie-green mb-4 text-2xl font-bold"
              x-cloak
            >
              Wähle
              <span
                x-text="options.max_time_slots"
                class="text-3xl font-bold underline"
              ></span>
              unterschiedliche Zeitslots
            </h2>
            <h2
              x-show="!canEditRoutePlanning"
              class="text-surfie-green mb-4 text-2xl font-bold"
              x-cloak
            >
              Ausgewählte Zeitslots
            </h2>

            <p class="text-gray-600 italic">
              Hinweis: Deadline für diese Angaben
              <span
                x-text="formatDateTime(options.route_planning_deadline)"
                class="font-semibold"
              ></span
              >.
            </p>
            <p
              x-show="!canEditRoutePlanning"
              class="text-rust mb-4 text-sm italic"
              x-cloak
            >
              (Nach der Deadline können die Angaben nicht mehr bearbeitet
              werden)
            </p>

            <p
              class="text-rust mt-2"
              x-show="canEditRoutePlanning && selectedTimeSlotIds.length >= options.max_time_slots"
              x-cloak
            >
              Du kannst maximal
              <span x-text="options.max_time_slots"></span> Zeitslots auswählen.
            </p>

            <div
              class="mt-2 mb-4"
              x-show="options.show_search_for_time_slots"
              x-cloak
            >
              <input
                type="text"
                class="focus:border-atlantis focus:ring-atlantis w-full rounded-md border border-gray-300 p-2 shadow-xs"
                x-model="timeSlotSearchQuery"
                placeholder="Suche nach Zeitslots..."
                data-testid="qa-time-slot-search"
              />
            </div>

            <div x-show="canEditRoutePlanning" class="space-y-6" x-cloak>
              <template
                x-for="(slotIds, date) in groupedTimeSlotIds"
                :key="date"
              >
                <div>
                  <h4
                    class="text-surfie-green mb-2 text-lg font-medium"
                    x-text="date"
                  ></h4>
                  <div class="grid grid-cols-1 gap-1 sm:grid-cols-2">
                    <template
                      x-for="slot in availableTimeSlots.filter(s => slotIds.includes(s.id)).filter(s => s.label.toLowerCase().includes(timeSlotSearchQuery.toLowerCase()))"
                      :key="slot.id"
                    >
                      <label
                        :class="{
                          'border-gray-200': !slot.isSelected,
                          'border-atlantis': slot.isSelected,
                          'border-2': slot.isSelected,
                          'm-0.5': !slot.isSelected,
                        }"
                        :data-testid="'qa-time-slot-' + slot.id"
                        class="flex items-center rounded-lg border p-3 shadow-xs"
                      >
                        <input
                          type="checkbox"
                          class="form-checkbox peer text-calypso h-5 w-5"
                          :value="slot.id"
                          @change="updateTimeSlot(slot.id)"
                          x-model="slot.isSelected"
                          :disabled="(selectedTimeSlotIds.length >= options.max_time_slots && !selectedTimeSlotIds.includes(slot.id)) || (slot.available_reservations <= 0)"
                        />
                        <span
                          class="ml-2 text-gray-800 select-none peer-disabled:text-gray-300"
                          x-text="slot.label"
                        ></span>
                        <span
                          x-show="slot.available_reservations <= 0"
                          class="text-sun-400 ml-2 text-sm"
                          x-cloak
                          >ausgebucht</span
                        >
                      </label>
                    </template>
                  </div>
                </div>
              </template>
            </div>

            <div x-show="selectedTimeSlotIds.length > 0" class="mt-6" x-cloak>
              <h4
                x-show="canEditRoutePlanning"
                class="text-surfie-green mb-2 text-lg font-medium"
                x-cloak
              >
                Ausgewählte Zeitslots:
              </h4>
              <ul class="space-y-2">
                <template x-for="slotId in selectedTimeSlotIds" :key="slotId">
                  <li
                    :data-testid="'qa-selected-time-slot-' + slotId"
                    class="flex items-center justify-between rounded-md bg-gray-100 p-2"
                  >
                    <span
                      x-text="availableTimeSlots.find(s => s.id === slotId).label"
                    ></span>
                    <button
                      x-show="canEditRoutePlanning"
                      :disabled="!canEditRoutePlanning"
                      @click="updateTimeSlot(slotId, false)"
                      :data-testid="'qa-remove-selected-slot-' + slotId"
                      class="focus:ring-java-500 focus:ring-opacity-50 text-gray-500 hover:text-gray-700 focus:ring-2 focus:outline-hidden"
                      x-cloak
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-5 w-5"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                          clip-rule="evenodd"
                        />
                      </svg>
                    </button>
                  </li>
                </template>
              </ul>
            </div>

            <form
              data-testid="qa-time-slot-form"
              class="mt-6 space-y-6"
              @submit.prevent="submitTimeSlots"
            >
              <!-- If not all possible time-slots until options.max_time_slots are selected, show a warning -->
              <p
                class="text-rust mt-4"
                x-show="canEditRoutePlanning && selectedTimeSlotIds.length < options.max_time_slots"
                x-cloak
              >
                Bitte wähle mindestens
                <span x-text="options.max_time_slots"></span> Zeitslots. Damit
                wir eine bestmögliche Fahrroute für unsere Nikoläuse erstellen
                können.
              </p>

              <!-- Submit Button -->
              <div x-show="canEditRoutePlanning" x-cloak>
                <button
                  type="submit"
                  data-testid="qa-time-slot-submit"
                  class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 w-full rounded-sm px-4 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
                >
                  Speichern & Weiter
                </button>
                <div
                  x-show="Object.keys(validationMessages).length > 0"
                  class="text-rust mx-2 mt-2 text-left text-sm"
                >
                  Bitte überprüfe deine Eingaben.
                </div>
              </div>
            </form>
          </div>
        </template>

        <!-- Step 3: Children Details -->
        <template x-if="step === 3" x-cloak>
          <div
            class="mx-auto w-full max-w-3xl rounded-lg bg-white p-6 shadow-md"
          >
            <h2 class="text-surfie-green mb-4 text-2xl font-bold">Kinder</h2>

            <p class="text-gray-600 italic">
              Hinweis: Die Informationen zu den Kindern können auch später
              ergänzt werden. Deadline für diese Angaben
              <span
                x-text="formatDateTime(options.final_deadline)"
                class="font-semibold"
              ></span
              >.
            </p>
            <p
              x-show="!canEditAnything"
              class="text-rust mb-4 text-sm italic"
              x-cloak
            >
              (Nach der Deadline können die Angaben nicht mehr bearbeitet
              werden)
            </p>

            <div
              class="mt-2 rounded-md border border-gray-300 bg-gray-50 p-3 text-left text-sm text-gray-700"
            >
              <p>
                Der Nikolaus erhält im Vorfeld Informationen zu den Kindern,
                sodass das goldene Buch individuell gefüllt werden kann. Eine
                solche Information sollte den Namen, ein eindeutiges
                Identifikationsmerkmal sowie Lob und ggf. Tadel enthalten.
              </p>
              <p class="mt-3">
                Bitte erwarten Sie in dieser kurzen Zeit keine pädagogischen
                Wunder. Nutzen Sie die Gelegenheit Ihre Kinder zu
                <b>loben</b> und <b>einen</b> oder maximal zwei
                Verbesserungsimpulse zu geben.
              </p>
              <p class="mt-3 font-semibold">Beispiele:</p>
              <ul class="ml-6 list-outside list-disc">
                <li>
                  <b>Kasimir</b> (8 Jahre, dunkle Haare, größtes Kind)<br />
                  <span class="text-emerald-700">+</span> kann toll zeichnen,
                  Kunst ist das Lieblingsfach in der 3. Klasse<br />
                  <span class="text-rust">–</span> ärgert seine Schwester oft
                </li>
                <li>
                  <b>Jule</b> (6 Jahre, lange blonde Haare)<br />
                  <span class="text-emerald-700">+</span> sehr aufgewecktes
                  Kind, in der ersten Klasse, freut sich jeden Tag auf die
                  Schule und zieht sich schon ganz alleine an<br />
                  <span class="text-rust">–</span> schreit sehr laut, wenn sie
                  sich mit ihrem Bruder Kasimir streitet
                </li>
                <li>
                  <b>Gustl</b> (2 Jahre, kleinstes Kind)<br />
                  <span class="text-emerald-700">+</span> großer Feuerwehr-Fan,
                  liebt seine Geschwister über alles, sagt immer Bitte und
                  Danke<br />
                  <span class="text-rust">–</span> stört Geschwister bei den
                  Hausaufgaben und akzeptiert nicht, dass sie auch Zeit ohne ihn
                  brauchen
                </li>
              </ul>
            </div>

            <p
              class="text-rust mt-6"
              x-show="canEditAnything && booking.children.length <= 0"
              x-cloak
            >
              Bitte füge mindestens ein Kind hinzu.
            </p>

            <form
              data-testid="qa-children-form"
              class="mt-6 space-y-6"
              @submit.prevent="submitChildren"
            >
              <!-- List of children -->
              <template x-for="(child, index) in booking.children" :key="index">
                <div
                  class="space-y-4 rounded-lg border border-gray-300 bg-gray-100 p-4"
                >
                  <div>
                    <label
                      :for="'child-name-' + index"
                      class="text-surfie-green block text-left font-medium"
                      >Name *</label
                    >
                    <input
                      :id="'child-name-' + index"
                      :data-testid="'qa-child-name-' + index"
                      type="text"
                      required
                      maxlength="50"
                      class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                      x-model="child.name"
                      placeholder="Name des Kindes"
                      :readonly="!canEditAnything"
                    />
                    <template
                      x-for="(message, index) in validationMessages[`booking.children[${index}].name`] || []"
                      :key="index"
                    >
                      <div
                        class="text-rust mx-2 mt-2 text-left text-sm"
                        x-text="message"
                      ></div
                    ></template>
                  </div>

                  <div>
                    <label
                      :for="'child-identification-' + index"
                      class="text-surfie-green block text-left font-medium"
                      >Identifikationsmerkmal</label
                    >
                    <input
                      :id="'child-identification-' + index"
                      :data-testid="'qa-child-identification-' + index"
                      type="text"
                      maxlength="250"
                      class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                      x-model="child.identification_trait"
                      placeholder="Alter, Haarfarbe, Größe, ..."
                      :readonly="!canEditAnything"
                    />
                    <template
                      x-for="(message, index) in validationMessages[`booking.children[${index}].identification_trait`] || []"
                      :key="index"
                    >
                      <div
                        class="text-rust mx-2 mt-2 text-left text-sm"
                        x-text="message"
                      ></div
                    ></template>
                  </div>

                  <div>
                    <label
                      :for="'child-speech-' + index"
                      class="text-surfie-green block text-left font-medium"
                      >Rede</label
                    >
                    <div
                      class="mt-2 rounded-md border border-gray-300 bg-gray-50 p-3 text-left text-sm text-gray-700"
                    >
                      <p>
                        Bitte schreib hier den Text rein, den der Nikolaus für
                        ein Kind vorlesen soll. Gerne in Stichpunkten oder auch
                        als Fließtext.
                      </p>
                    </div>
                    <textarea
                      :id="'child-speech-' + index"
                      :data-testid="'qa-child-speech-' + index"
                      class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                      x-model="child.speech"
                      rows="8"
                      placeholder="Rede für den Nikolaus"
                      :readonly="!canEditAnything"
                    ></textarea>
                    <template
                      x-for="(message, index) in validationMessages[`booking.children[${index}].speech`] || []"
                      :key="index"
                    >
                      <div
                        class="text-rust mx-2 mt-2 text-left text-sm"
                        x-text="message"
                      ></div
                    ></template>
                  </div>
                  <button
                    x-show="canEditAnything"
                    :disabled="!canEditAnything"
                    type="button"
                    @click="removeChild(index)"
                    :data-testid="'qa-remove-child-' + index"
                    class="focus:ring-rust focus:ring-opacity-50 mt-2 rounded-sm bg-red-500 px-3 py-1 text-sm font-bold text-white hover:bg-red-600 focus:ring-2 focus:outline-hidden"
                    x-cloak
                  >
                    Kind entfernen
                  </button>
                </div>
              </template>

              <!-- Add child button -->
              <div x-show="canEditAnything" class="mt-4" x-cloak>
                <button
                  type="button"
                  @click="addChild"
                  :disabled="!canEditAnything"
                  data-testid="qa-add-child"
                  class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 rounded-sm px-4 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
                >
                  Kind hinzufügen
                </button>
              </div>

              <!-- Additional Notes -->
              <div>
                <label
                  for="additional_notes"
                  class="text-surfie-green block text-left font-medium"
                  >Sonstige Beachtungen</label
                >
                <div
                  class="mt-2 rounded-md border border-gray-300 bg-gray-50 p-3 text-left text-sm text-gray-700"
                >
                  <p>
                    Hier kannst du weitere wichtige Informationen für die
                    Nikoläuse hinterlegen, z. B. die Kinder wollen dem Nikolaus
                    ein Lied singen / Besonderheiten zu Hunden / Haustieren, zum
                    Haus / Grundstück oder sonstige Hinweise.
                  </p>
                </div>
                <textarea
                  id="additional_notes"
                  data-testid="qa-additional-notes"
                  class="focus:border-atlantis focus:ring-atlantis mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-xs"
                  x-model="booking.additional_notes"
                  rows="4"
                  placeholder="Weitere Hinweise für den Nikolaus"
                  :readonly="!canEditAnything"
                ></textarea>
                <template
                  x-for="(message, index) in validationMessages['booking.additional_notes'] || []"
                  :key="index"
                >
                  <div
                    class="text-rust mx-2 mt-2 text-left text-sm"
                    x-text="message"
                  ></div
                ></template>
              </div>

              <!-- Submit Button -->
              <div x-show="canEditAnything" x-cloak>
                <button
                  type="submit"
                  data-testid="qa-children-submit"
                  class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 w-full rounded-sm px-4 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
                >
                  Speichern & Weiter
                </button>
                <div
                  x-show="Object.keys(validationMessages).length > 0"
                  class="text-rust mx-2 mt-2 text-left text-sm"
                >
                  Bitte überprüfe deine Eingaben.
                </div>
              </div>
            </form>

            <!-- Skip to Next Step Button -->
            <div x-show="canEditAnything" class="mt-4" x-cloak>
              <button
                type="button"
                @click="setStep(4)"
                data-testid="qa-children-skip"
                class="border-atlantis text-atlantis hover:border-surfie-green hover:text-surfie-green focus:ring-java focus:ring-opacity-50 w-full rounded-sm border-2 px-4 py-2 font-bold focus:ring-2 focus:outline-hidden"
              >
                Aktuell überspringen (nicht speichern)
              </button>
            </div>
          </div>
        </template>

        <!-- Step 4: Summary -->
        <template x-if="step === 4" x-cloak>
          <div
            class="mx-auto w-full max-w-3xl p-4"
            data-testid="qa-step-panel-summary"
          >
            <h2 class="text-calypso mb-4 text-2xl font-bold">
              Vielen Dank für deine Anmeldung.
            </h2>

            <!-- Route planning is filled -->
            <div
              x-show="isRoutePlanningFilled && !isEverythingFilled"
              class="mb-4 flex items-start gap-2 text-left text-gray-700"
              data-testid="qa-summary-route-complete"
              x-cloak
            >
              <div class="shrink-0">
                <svg
                  class="text-atlantis h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    clip-rule="evenodd"
                    fill-rule="evenodd"
                    d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z"
                  ></path>
                </svg>
              </div>
              <p>Für unsere Routenplanung haben wir nun alle Informationen.</p>
            </div>

            <!-- Route planning is missing -->
            <div
              x-show="!isRoutePlanningFilled"
              class="text-rust mb-4 flex items-start gap-2 text-left"
              data-testid="qa-summary-route-missing"
              x-cloak
            >
              <div class="shrink-0">
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    clip-rule="evenodd"
                    fill-rule="evenodd"
                    d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z"
                  ></path>
                </svg>
              </div>
              <p>
                Bitte ergänze bis zum
                <span
                  x-text="formatDateTime(options.route_planning_deadline)"
                  class="font-bold"
                ></span>
                die Adresse und die Zeitslots, damit wir die Routen für die
                Nikoläuse erstellen können.
              </p>
            </div>

            <!-- Something is missing -->
            <div
              x-show="!isEverythingFilled"
              class="text-rust mb-4 flex items-start gap-2 text-left"
              data-testid="qa-summary-details-missing"
              x-cloak
            >
              <div class="shrink-0">
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    clip-rule="evenodd"
                    fill-rule="evenodd"
                    d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z"
                  ></path>
                </svg>
              </div>
              <p>
                Bitte ergänze bis zum
                <span
                  x-text="formatDateTime(options.final_deadline)"
                  class="font-bold"
                ></span>
                die noch fehlenden Details für die Nikoläuse. Nutze dafür
                jederzeit den Link in der Bestätigungs-E-Mail. Deine Angaben
                helfen uns, den Nikolausbesuch für deine Kinder so persönlich
                und schön wie möglich zu gestalten.
              </p>
            </div>

            <!-- Success -->
            <p
              x-show="isEverythingFilled"
              class="mb-4 text-gray-700"
              data-testid="qa-summary-all-complete"
              x-cloak
            >
              Wir haben alle erforderlichen Informationen erhalten.
            </p>
            <div
              x-show="isEverythingFilled"
              class="text-atlantis my-6 flex items-center justify-center"
              data-testid="qa-summary-checkmark"
              x-cloak
            >
              <svg
                class="h-32 w-32"
                fill="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
                data-slot="icon"
              >
                <path
                  clip-rule="evenodd"
                  fill-rule="evenodd"
                  d="M8.603 3.799A4.49 4.49 0 0 1 12 2.25c1.357 0 2.573.6 3.397 1.549a4.49 4.49 0 0 1 3.498 1.307 4.491 4.491 0 0 1 1.307 3.497A4.49 4.49 0 0 1 21.75 12a4.49 4.49 0 0 1-1.549 3.397 4.491 4.491 0 0 1-1.307 3.497 4.491 4.491 0 0 1-3.497 1.307A4.49 4.49 0 0 1 12 21.75a4.49 4.49 0 0 1-3.397-1.549 4.49 4.49 0 0 1-3.498-1.306 4.491 4.491 0 0 1-1.307-3.498A4.49 4.49 0 0 1 2.25 12c0-1.357.6-2.573 1.549-3.397a4.49 4.49 0 0 1 1.307-3.497 4.49 4.49 0 0 1 3.497-1.307Zm7.007 6.387a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z"
                ></path>
              </svg>
            </div>

            <!-- Info -->
            <div class="text-calypso mb-4 flex items-start gap-2 text-left">
              <div class="shrink-0">
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    clip-rule="evenodd"
                    fill-rule="evenodd"
                    d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"
                  ></path>
                </svg>
              </div>
              <p>
                Sobald wir die Routen geplant haben, erhältst du eine
                Rückmeldung, welchen Zeitslot wir für dich vorsehen.
              </p>
            </div>

            <div class="text-calypso mb-4 flex items-start gap-2 text-left">
              <div class="shrink-0">
                <svg
                  class="h-6 w-6"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                  aria-hidden="true"
                  data-slot="icon"
                >
                  <path
                    clip-rule="evenodd"
                    fill-rule="evenodd"
                    d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z"
                  ></path>
                </svg>
              </div>
              <p>
                Du kannst deine Angaben jederzeit bis zur jeweiligen Deadline
                ändern. Nutze dafür den Link aus der Bestätigungs-E-Mail.
              </p>
            </div>
          </div>
        </template>
      </div>

      <!-- View for email verification needed -->
      <template x-if="view === 'email-verification-needed'" x-cloak>
        <div
          class="mx-auto mt-8 w-full max-w-3xl rounded-lg bg-white p-6 shadow-md"
          data-testid="qa-email-verification"
        >
          <h2 class="text-surfie-green mb-4 text-2xl font-bold">
            E-Mail-Verifizierung
          </h2>

          <p class="text-gray-700">
            Wir haben dir eine E-Mail an
            <span
              class="font-bold"
              x-text="booking.contact_person.email"
            ></span>
            gesendet. Bitte klicke auf den Link in der E-Mail, um deine
            E-Mail-Adresse zu bestätigen und fortzufahren.
          </p>

          <p class="mt-4 text-gray-700">
            Falls du keine E-Mail erhalten hast, überprüfe bitte deinen Spam-
            oder Junk-Ordner.
          </p>

          <div class="mt-6">
            <button
              type="button"
              x-on:click="sendEmailVerification"
              data-testid="qa-email-resend"
              class="bg-atlantis hover:bg-surfie-green focus:ring-java focus:ring-opacity-50 w-full rounded-sm px-4 py-2 font-bold text-white focus:ring-2 focus:outline-hidden"
            >
              E-Mail erneut senden
            </button>
          </div>
        </div>
      </template>

      <!-- Footer -->
      <footer class="mt-8 w-full p-4 text-center text-sm text-gray-700">
        <p>
          &copy; <span x-text="new Date().getFullYear()"></span> KjG Bad Abbach
        </p>
        <div>
          <a
            x-show="options.legal_notice_link"
            :href="options.legal_notice_link"
            class="text-gray-700 hover:text-gray-900"
            x-cloak
            >Impressum</a
          >
          <span
            x-show="options.legal_notice_link && options.privacy_policy_link"
            class="mx-2"
            x-cloak
            >|</span
          >
          <a
            x-show="options.privacy_policy_link"
            :href="options.privacy_policy_link"
            class="text-gray-700 hover:text-gray-900"
            x-cloak
            >Datenschutz</a
          >
        </div>
        <div>Alle Daten werden nach der Aktion vollständig gelöscht.</div>
      </footer>

      <!-- Backdrop and Modal for error messages -->
      <div
        x-show="error"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="bg-opacity-50 fixed inset-0 z-50 flex items-center justify-center bg-black"
        @click.self="closeError()"
        x-cloak
      >
        <!-- Modal content -->
        <div
          class="max-h-[95vh] w-full max-w-lg overflow-y-auto rounded-lg border-s-4 border-red-500 bg-red-50 p-8 text-left shadow-2xl"
          role="alert"
          data-testid="qa-error-modal"
        >
          <div class="flex items-center gap-2 text-red-800">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              fill="currentColor"
              class="size-5 shrink-0"
            >
              <path
                fill-rule="evenodd"
                d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z"
                clip-rule="evenodd"
              />
            </svg>

            <strong class="block font-medium">
              <span x-text="error?.message"></span>
            </strong>
          </div>

          <div
            x-show="error?.status || error?.body"
            x-data="{ open: false }"
            class="mt-4"
            x-cloak
          >
            <a
              x-on:click="open = !open"
              :class="{ 'font-bold': open }"
              data-testid="qa-error-details-toggle"
              class="cursor-pointer text-red-700 underline"
              >Details</a
            >
            <div x-show="open" class="text-sm text-red-700" x-cloak>
              <p x-show="error?.status" x-cloak>
                <span class="font-bold">Status:</span>
                <span x-text="error?.status?.code"></span> (<span
                  x-text="error?.status?.text"
                ></span
                >)
              </p>
              <p x-show="error?.body" x-cloak>
                <code
                  class="block overflow-x-scroll whitespace-pre"
                  x-text="JSON.stringify(error?.body, null, '  ')"
                ></code>
              </p>
            </div>
          </div>

          <div class="mt-4 flex justify-end gap-2">
            <button
              x-show="askToReload"
              @click="reload()"
              type="button"
              data-testid="qa-error-retry"
              class="focus:ring-java-500 focus:ring-opacity-50 rounded-sm border-2 border-gray-400 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-600 focus:ring-2 focus:outline-hidden"
              x-cloak
            >
              Erneut versuchen
            </button>
            <button
              x-show="!askToReload"
              @click="closeError()"
              type="button"
              data-testid="qa-error-dismiss"
              class="focus:ring-java-500 focus:ring-opacity-50 rounded-sm border-2 border-gray-400 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-600 focus:ring-2 focus:outline-hidden"
              x-cloak
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const BOOKING_TEST_API_HOOK = "__bookingTestApi";
      let bookingTestApiWarningShown = false;

      async function sendRequest({ url, method = "GET", body = null }) {
        let passthroughErrors = false;
        try {
          const originalUrl = url;
          // Prepare URL (trim leading slash and trim api/ prefix)
          url = url.replace(/^\/?(?:api\/)?/g, "");

          const hook = window?.[BOOKING_TEST_API_HOOK];
          if (hook && typeof hook.handleRequest === "function") {
            if (!bookingTestApiWarningShown) {
              bookingTestApiWarningShown = true;
              console.warn(
                "[Nikolaus Booking] window.__bookingTestApi override is active; HTTP requests are being stubbed.",
              );
            }
            try {
              return await hook.handleRequest({
                url,
                method,
                body: body ? clone(body) : null,
                originalUrl,
              });
            } catch (hookError) {
              passthroughErrors = true;
              throw hookError;
            }
          }

          // Prepare the fetch options
          const options = {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
          };
          if (API_TOKEN) {
            options.headers.Authorization = `Bearer ${API_TOKEN}`;
          }

          // If body is provided, stringify it and attach to the options
          if (body) {
            options.body = JSON.stringify(body);
          }

          // Send the fetch request
          const response = await fetch(
            `${API_BASE_URL ? API_BASE_URL : ""}/api/${url}`,
            options,
          );

          // Handle non-OK responses (status codes outside of 200-299)
          if (!response.ok) {
            let responseBody = await response.text();
            try {
              responseBody = JSON.parse(responseBody);
            } catch {}

            // Construct the error object
            const errorObj = {
              message:
                responseBody?.error?.name === "ValidationError"
                  ? "Bitte überprüfe deine Eingaben."
                  : "Ein Fehler ist aufgetreten. Bitte versuche es erneut.",
              status: {
                code: response.status,
                text: response.statusText,
              },
              body: responseBody,
            };

            passthroughErrors = true;
            throw errorObj; // Throw error for further handling
          }

          // Parse and return the JSON response body
          return await response.json();
        } catch (error) {
          if (passthroughErrors) {
            throw error; // Re-throw the error if it's a passthrough error
          }

          // Log the error and throw it so it can be handled by the caller
          console.error("Request failed:", error);

          // Construct a more detailed error object if it's a network error
          const errorDetails = {
            message:
              error.message ||
              "Ein Fehler ist aufgetreten. Bitte versuche es erneut.",
            body: {
              message: error.toString(),
              fileName: error.fileName,
              lineNumber: error.lineNumber,
              columnNumber: error.columnNumber,
              cause: error.cause,
              stack: error.stack?.split("\n"),
            },
          };

          throw errorDetails; // Re-throw the error so the caller can handle it
        }
      }

      function clone(value) {
        return JSON.parse(JSON.stringify(value));
      }

      function updateExistingObjectKeys(obj, newObj) {
        Object.keys(obj).forEach((key) => {
          if (newObj[key]) {
            if (Array.isArray(obj[key]) && Array.isArray(newObj[key])) {
              obj[key] = clone(newObj[key]);
            } else if (obj[key] instanceof Date) {
              obj[key] = new Date(newObj[key]);
            } else if (typeof obj[key] === "string") {
              obj[key] = (newObj[key] || "").toString();
            } else if (typeof obj[key] === "object" && obj[key]) {
              // If property is object, call the function recursively
              updateExistingObjectKeys(obj[key], newObj[key]);
            } else {
              obj[key] = clone(newObj[key]);
            }
          }
        });
      }

      function extendExistingObjectKeys(obj, newObj) {
        Object.keys(newObj).forEach((key) => {
          if (obj[key] === undefined) {
            return;
          }
          if (Array.isArray(obj[key]) && Array.isArray(newObj[key])) {
            obj[key] = obj[key].concat(newObj[key]);
          } else if (typeof obj[key] === "string") {
            obj[key] = (obj[key] + " " + (newObj[key] || "")).trim();
          } else if (typeof obj[key] === "object" && obj[key]) {
            // If property is object, call the function recursively
            extendExistingObjectKeys(obj[key], newObj[key]);
          } else {
            throw new Error("Unknown key type");
          }
        });
      }

      function trim(value) {
        // Also clean soft hyphen: \u00AD
        return (value || "").replace(/^[\s\u00AD]+|\u00AD+|[\s\u00AD]+$/g, "");
      }

      function isFilled(value) {
        return trim(value) ? true : false;
      }

      const currentYear = new Date().getFullYear();

      const formatDate = (date) => {
        const day = date.toLocaleDateString("de-DE", {
          weekday: "short",
        });
        const dateNum = date.getDate();
        const month = date.getMonth() + 1;
        const year =
          date.getFullYear() !== currentYear ? ` ${date.getFullYear()}` : "";
        return `${day} ${dateNum}.${month}.${year}`;
      };

      const formatTime = (date) => {
        return `${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}`;
      };

      const formatDateTime = (date) => {
        return `${formatDate(date)} ${formatTime(date)} Uhr`;
      };

      const formatDateTimeRange = (start, end) => {
        const startStr = `${formatDate(start)} ${formatTime(start)}`;
        const endStr = formatTime(end);

        const endDateStr =
          start.getDate() !== end.getDate() ||
          start.getMonth() !== end.getMonth() ||
          start.getFullYear() !== end.getFullYear()
            ? `${formatDate(end)} `
            : "";

        return `${startStr} - ${endDateStr}${endStr} Uhr`;
      };

      const formatTimeSlotGroup = (date) => {
        return formatDate(date);
      };

      class RichTextBlocksRenderer {
        constructor(content, defaultClasses = {}) {
          this.content = content;
          this.defaultClasses = {
            heading1: "text-4xl font-bold mb-4",
            heading2: "text-3xl font-bold mb-3",
            heading3: "text-2xl font-bold mb-2",
            heading4: "text-xl font-bold mb-1",
            heading5: "text-lg font-bold mb-1",
            heading6: "text-base font-bold mb-1",
            paragraph: "mb-4",
            list: "mb-4 ml-4 list-inside",
            orderedList: "",
            orderedListLevels: [
              "list-decimal",
              "list-lower-alpha",
              "list-lower-roman",
            ],
            unorderedList: "",
            unorderedListLevels: ["list-disc", "list-circle", "list-square"],
            listItem: "mb-1",
            link: "text-blue-600 hover:underline",
            code: "bg-gray-100 rounded-sm px-1 font-mono",
          };
          // Extend defaultClasses with provided classes (overwrites existing ones)
          updateExistingObjectKeys(this.defaultClasses, defaultClasses);
          // Extend defaultClasses with provided classes (adds new ones)
          extendExistingObjectKeys(
            this.defaultClasses,
            defaultClasses.extend || {},
          );
        }

        render() {
          return this.renderNodes(this.content);
        }

        renderNodes(nodes) {
          if (!Array.isArray(nodes)) return "";
          return nodes.map((node) => this.renderNode(node)).join("");
        }

        renderNode(node) {
          if (!node) return "";

          // Handle text nodes with formatting
          if (node.text !== undefined) {
            return this.renderFormattedText(node);
          }

          // Handle structural nodes
          switch (node.type) {
            case "heading":
              const headingClass = this.defaultClasses[`heading${node.level}`];
              return `<h${node.level} class="${headingClass}">${this.renderNodes(node.children)}</h${node.level}>`;

            case "paragraph":
              return `<p class="${this.defaultClasses.paragraph}">${this.renderNodes(node.children)}</p>`;

            case "list":
              return this.renderList(node);

            case "list-item":
              return `<li class="${this.defaultClasses.listItem}">${this.renderNodes(node.children)}</li>`;

            case "link":
              return `<a href="${node.url}" class="${this.defaultClasses.link}">${this.renderNodes(node.children)}</a>`;

            default:
              // For any nested content that might exist
              return node.children ? this.renderNodes(node.children) : "";
          }
        }

        renderList(node) {
          const tag = node.format === "ordered" ? "ol" : "ul";
          const indentLevel = node.indentLevel || 0;
          const baseClass = this.defaultClasses.list;
          const listClass =
            node.format === "ordered"
              ? this.defaultClasses.orderedList +
                " " +
                this.defaultClasses.orderedListLevels[
                  indentLevel % this.defaultClasses.orderedListLevels.length
                ]
              : this.defaultClasses.unorderedList +
                " " +
                this.defaultClasses.unorderedListLevels[
                  indentLevel % this.defaultClasses.unorderedListLevels.length
                ];

          const classes = `${baseClass} ${listClass}`.trim();

          return `<${tag} class="${classes}">${this.renderNodes(node.children)}</${tag}>`;
        }

        renderFormattedText(node) {
          let content = node.text;

          // Build array of formatting operations
          const formatting = [];

          if (node.code) {
            formatting.push({
              tag: "code",
              class: this.defaultClasses.code,
            });
          }
          if (node.bold) {
            formatting.push({
              tag: "strong",
              class: "font-bold",
            });
          }
          if (node.italic) {
            formatting.push({
              tag: "em",
              class: "italic",
            });
          }
          if (node.underline) {
            formatting.push({
              tag: "span",
              class: "underline",
            });
          }
          if (node.strikethrough) {
            formatting.push({
              tag: "span",
              class: "line-through",
            });
          }

          // Apply all formatting
          formatting.forEach((format) => {
            content = `<${format.tag}${format.class ? ` class="${format.class}"` : ""}>${content}</${format.tag}>`;
          });

          return content;
        }
      }

      // Handle unsaved changes during browser window closing
      let checkHasUnsavedChangesCallback = null; // Callback to check for unsaved changes

      // Function to register a callback for checking unsaved changes
      function registerCheckHasUnsavedChangesCallback(callback) {
        checkHasUnsavedChangesCallback = callback;
      }

      // Function to handle unsaved changes
      function handleUnsavedChanges(event, action) {
        if (
          checkHasUnsavedChangesCallback &&
          checkHasUnsavedChangesCallback()
        ) {
          const confirmationMessage = `Es gibt ungespeicherte Änderungen. Möchten Sie die Seite wirklich ${action}?`;
          event.returnValue = confirmationMessage; // Standard for most browsers
          return confirmationMessage; // For some older browsers
        }
      }

      // Event listener for beforeunload
      window.addEventListener("beforeunload", (event) =>
        handleUnsavedChanges(event, "verlassen"),
      );

      // Event listener for page reload
      window.addEventListener("popstate", (event) =>
        handleUnsavedChanges(event, "neu laden"),
      );

      document.addEventListener("alpine:init", () => {
        Alpine.data("bookingForm", () => ({
          options: {
            id: null,
            show_search_for_time_slots: false,
            max_time_slots: 3,
            route_planning_deadline: new Date("2004-11-27T23:59:59+01:00"), // UTC+1 (Europe/Berlin)
            final_deadline: new Date("2004-12-01T23:59:59+01:00"), // UTC+1 (Europe/Berlin)
            introduction_text: [],
            privacy_policy_link: null,
            legal_notice_link: null,
          },
          isLoading: false,
          error: null,
          validationMessages: {},
          errorCloseCallback: null,
          closeError() {
            this.error = null;
            const callback = this.errorCloseCallback;
            this.errorCloseCallback = null;
            if (callback) {
              callback();
            }
          },
          askToReload: false,
          view: "intro",
          step: 0,
          canJumpToAnyStep: false,
          async setStep(step) {
            if (this.canJumpToAnyStep) {
              let fetchedTimeSlots = false;
              // Check if inputs have changed and saving is needed
              if (this.bookingHasChanges()) {
                if (
                  !confirm(
                    "Wenn Sie fortfahren, werden Ihre Änderungen verloren gehen. Fortfahren?",
                  )
                ) {
                  return;
                }
                // Reset data to database values
                this.booking = this.bookingEmpty();
                updateExistingObjectKeys(
                  this.booking,
                  clone(this.bookingLoadedFromDatabase),
                );
                this.fetchTimeSlots();
                fetchedTimeSlots = true;
              }

              this.validationMessages = {};
              this.step = step;
              if (step === 2 && !fetchedTimeSlots) {
                await this.fetchTimeSlots();
              }
            }
          },
          steps: [
            {
              name: "Kontakt",
              testId: "contact",
              anyFilled: false,
              allFilled: false,
            },
            {
              name: "Adresse",
              testId: "address",
              anyFilled: false,
              allFilled: false,
            },
            {
              name: "Zeitslot",
              testId: "time-slot",
              anyFilled: false,
              allFilled: false,
            },
            {
              name: "Kinder",
              testId: "children",
              anyFilled: false,
              allFilled: false,
            },
            {
              name: "Kontrolle",
              testId: "summary",
              anyFilled: false,
              allFilled: false,
            },
          ],
          bookingId: null,
          canEditRoutePlanning: false,
          canEditAnything: false,
          updateCanEdit() {
            this.canEditRoutePlanning =
              new Date() < this.options.route_planning_deadline;
            this.canEditAnything = new Date() < this.options.final_deadline;
          },
          isRoutePlanningFilled: false,
          isEverythingFilled: false,
          selectedTimeSlotIds: [],
          availableTimeSlots: [], // API-fetched time-slots
          groupedTimeSlotIds: {},
          timeSlotSearchQuery: "",
          bookingEmpty() {
            return {
              contact_person: {
                first_name: "",
                last_name: "",
                email: "",
                phone_number: "",
              },
              location: {
                street: "",
                house_number: "",
                zip_code: "",
                place: "",
              },
              present_location: "",
              children: [],
              time_slots: [],
              additional_notes: "",
            };
          },
          booking: {},
          bookingLoadedFromDatabase: {},
          bookingHasChanges() {
            const log = (...args) => {
              const result = args[args.length - 1];
              if (result) {
                console.log(...args);
              }
              return result;
            };

            const hasChanges = (current, database) => {
              if (Array.isArray(current)) {
                if (current.length !== (database || []).length) {
                  return log("array-size", current, database, true);
                }
                return log(
                  "array",
                  current,
                  database,
                  current.some((x, index) => {
                    const currentValue = x;
                    const databaseValue = (database || [])[index];
                    return log(
                      "array-item",
                      index,
                      currentValue,
                      databaseValue,
                      hasChanges(currentValue, databaseValue),
                    );
                  }),
                );
              } else if (typeof current === "object" && current) {
                const currentKeys = Object.keys(current);
                return log(
                  "object",
                  current,
                  database,
                  currentKeys.some((key) => {
                    const currentValue =
                      key === "time_slots"
                        ? this.selectedTimeSlotIds.sort()
                        : current[key];
                    const databaseValue =
                      key === "time_slots"
                        ? ((database || {})[key] || [])
                            .map((x) => x.documentId)
                            .sort()
                        : (database || {})[key];
                    return log(
                      "object-item",
                      key,
                      currentValue,
                      databaseValue,
                      hasChanges(currentValue, databaseValue),
                    );
                  }),
                );
              } else if (typeof current === "string") {
                return log(
                  "string",
                  current,
                  database,
                  trim(current) !== trim(database),
                );
              } else if (
                (current === null ||
                  current === undefined ||
                  (typeof current === "string" && !isFilled(current))) &&
                (database === null ||
                  database === undefined ||
                  (typeof database === "string" && !isFilled(database)))
              ) {
                return log("null-or-empty", current, database, false);
              }
              return log("other", current, database, current !== database);
            };

            log("hasChanges");
            log(JSON.stringify(this.booking));
            log(JSON.stringify(this.bookingLoadedFromDatabase));
            return log(
              "end",
              hasChanges(this.booking, this.bookingLoadedFromDatabase),
            );
          },

          async init() {
            if (this.isLoading) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            this.booking = this.bookingEmpty();
            registerCheckHasUnsavedChangesCallback(() =>
              this.bookingHasChanges(),
            );
            try {
              if (!this.options.id) {
                const response = await sendRequest({
                  url: "/api/config?populate=*",
                });
                if (!API_TOKEN) {
                  API_TOKEN = response.data.api_token;
                }
                if (!API_BASE_URL) {
                  API_BASE_URL = response.data.api_base_url;
                }
                updateExistingObjectKeys(this.options, response.data);
                if (
                  this.options.introduction_text &&
                  this.options.introduction_text.length
                ) {
                  this.view = "intro";
                  const content = document.querySelector("#introduction-text");
                  const renderer = new RichTextBlocksRenderer(
                    this.options.introduction_text,
                    {
                      extend: {
                        heading1: "text-calypso",
                        heading2: "text-calypso",
                        heading3: "text-calypso",
                        heading4: "text-calypso",
                        heading5: "text-calypso",
                        heading6: "text-calypso",
                        list: "marker:text-calypso",
                        link: "text-atlantis hover:text-surfie-green",
                      },
                    },
                  );
                  content.innerHTML = renderer.render();
                } else {
                  this.view = "steps";
                }
              }
              this.updateCanEdit();

              // Get the query parameters from the URL
              const params = new URLSearchParams(window.location.search);

              // Read the "id" parameter from the URL and store it in the bookingId variable
              this.bookingId = params.get("id") || null;

              this.isLoading = false;

              if (this.bookingId) {
                this.view = "steps";

                await this.updateFromDatabase();
              }
            } catch (error) {
              console.error(error);
              this.isLoading = false;
              this.error = error;
              this.askToReload = true;
            }
          },

          async reload() {
            await this.init();
          },

          // Update data based on the fetched data
          async updateFromDatabase() {
            if (this.isLoading) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            this.booking = this.bookingEmpty();
            this.bookingLoadedFromDatabase = {};
            try {
              // Fetch the booking data from the API
              const response = await sendRequest({
                url: `/api/bookings/${this.bookingId}?populate=*`,
              });
              const data = clone(response.data);

              // Update the booking object with the fetched data
              updateExistingObjectKeys(this.booking, data);

              // Update selected time-slots
              await this.fetchTimeSlots(/*forceWhileLoading*/ true);
              if (this.error) {
                throw this.error;
              }

              // Store database state
              this.bookingLoadedFromDatabase = clone(response.data);

              // Can jump to any step if bookingId is set
              this.canJumpToAnyStep = !!this.bookingId;

              await this.setStep(0);

              // Step 0: Contact Details
              const isContactDetailsFilled =
                isFilled(data.contact_person?.first_name) &&
                isFilled(data.contact_person?.last_name) &&
                isFilled(data.contact_person?.email) &&
                isFilled(data.contact_person?.phone_number);
              this.steps[0].allFilled = isContactDetailsFilled;
              this.steps[0].anyFilled =
                isFilled(data.contact_person?.first_name) ||
                isFilled(data.contact_person?.last_name) ||
                isFilled(data.contact_person?.email) ||
                isFilled(data.contact_person?.phone_number);
              if (this.steps[0].allFilled && this.step === 0) {
                await this.setStep(1);
              }

              // Step 1: Address
              const isAddressFilled =
                isFilled(data.location?.street) &&
                isFilled(data.location?.house_number) &&
                isFilled(data.location?.zip_code) &&
                isFilled(data.location?.place);
              const isPresentLocationFilled = isFilled(data.present_location);
              this.steps[1].allFilled =
                isAddressFilled && isPresentLocationFilled;
              this.steps[1].anyFilled =
                isFilled(data.location?.street) ||
                isFilled(data.location?.house_number) ||
                isFilled(data.location?.zip_code) ||
                isFilled(data.location?.place) ||
                isFilled(data.present_location);
              if (this.steps[1].allFilled && this.step === 1) {
                await this.setStep(2);
              }

              // Step 2: Time-Slot
              const areTimeSlotsFilled =
                data.time_slots?.length >= this.options.max_time_slots;
              this.steps[2].allFilled = areTimeSlotsFilled;
              this.steps[2].anyFilled = !!data.time_slots?.length;
              if (this.steps[2].allFilled && this.step === 2) {
                await this.setStep(3);
              }

              // Step 3: Children
              const areChildrenFilled =
                data.children?.length &&
                data.children.every(
                  (child) =>
                    isFilled(child.name) &&
                    isFilled(child.identification_trait) &&
                    isFilled(child.speech),
                );
              this.steps[3].allFilled = areChildrenFilled;
              this.steps[3].anyFilled =
                !!data.children?.length || isFilled(data.additional_notes);
              if (this.steps[3].allFilled && this.step === 3) {
                await this.setStep(4);
              }

              // Step 4: Review
              this.isRoutePlanningFilled =
                isAddressFilled && areTimeSlotsFilled;
              this.isEverythingFilled =
                isContactDetailsFilled &&
                isAddressFilled &&
                isPresentLocationFilled &&
                areTimeSlotsFilled &&
                areChildrenFilled;
              this.steps[4].allFilled = this.isEverythingFilled;
              this.steps[4].anyFilled = false;
            } catch (error) {
              console.error(error);
              this.error = error;
            } finally {
              this.isLoading = false;
            }
          },

          // Extract validation messages from error object
          errorToValidationMessages(body) {
            const errors = body?.error?.details?.errors;
            if (!errors?.length) {
              return;
            }
            for (const err of errors) {
              const path = err.path.join(".");
              let msg = err.message.startsWith(path + " ")
                ? err.message.substring((path + " ").length)
                : err.message;
              if (msg === 'must match the following: "/^\\+?[-\\s\\.0-9]+$/"') {
                msg =
                  "Die Telefonnummer muss im Format '01234 56789', '01234 567-89', '+49 123 456789' oder '0049 123 456789' sein.";
              }
              if (!this.validationMessages["booking." + path]) {
                this.validationMessages["booking." + path] = [];
              }
              this.validationMessages["booking." + path].push(msg);
            }
          },

          // Step 0: Submit Contact Details
          async submitContactDetails() {
            if (this.isLoading) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            this.validationMessages = {};
            try {
              // Clean input
              this.booking.contact_person.first_name = trim(
                this.booking.contact_person.first_name,
              );
              this.booking.contact_person.last_name = trim(
                this.booking.contact_person.last_name,
              );
              this.booking.contact_person.email = trim(
                this.booking.contact_person.email,
              );
              this.booking.contact_person.phone_number = trim(
                this.booking.contact_person.phone_number,
              );

              // Check if required fields filled
              if (!isFilled(this.booking.contact_person.first_name)) {
                this.validationMessages["booking.contact_person.first_name"] = [
                  "Eingabe ist erforderlich.",
                ];
              }
              if (!isFilled(this.booking.contact_person.last_name)) {
                this.validationMessages["booking.contact_person.last_name"] = [
                  "Eingabe ist erforderlich.",
                ];
              }
              if (!isFilled(this.booking.contact_person.email)) {
                this.validationMessages["booking.contact_person.email"] = [
                  "Eingabe ist erforderlich.",
                ];
              }
              if (!isFilled(this.booking.contact_person.phone_number)) {
                this.validationMessages["booking.contact_person.phone_number"] =
                  ["Eingabe ist erforderlich."];
              }

              // Exit on validation errors
              if (Object.keys(this.validationMessages).length) {
                return;
              }

              const hadBookingId = !!this.bookingId;

              const response = await sendRequest({
                url: this.bookingId
                  ? `/api/bookings/${this.bookingId}`
                  : "/api/bookings",
                method: this.bookingId ? "PUT" : "POST",
                body: {
                  data: {
                    contact_person: this.booking.contact_person,
                  },
                },
              });

              this.bookingId = response.data.documentId;
              this.isLoading = false;
              if (hadBookingId) {
                this.view = "steps";
                await this.init();
              } else {
                this.bookingLoadedFromDatabase = clone(this.booking);
                this.view = "email-verification-needed";
              }
              await this.setStep(1);
            } catch (error) {
              console.error(error);
              this.error = error;
              this.errorToValidationMessages(error.body);
            } finally {
              this.isLoading = false;
            }
          },

          // Send email verification again
          async sendEmailVerification() {
            if (this.isLoading) {
              return;
            }
            if (!confirm("E-Mail erneut senden?")) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            try {
              await sendRequest({
                url: `/api/bookings/${this.bookingId}/send-verification-email`,
                method: "POST",
              });
            } catch (error) {
              console.error(error);
              this.error = error;
            } finally {
              this.isLoading = false;
            }
          },

          // Step 1: Submit Address
          async submitAddress() {
            if (this.isLoading) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            this.validationMessages = {};
            try {
              // Clean input
              this.booking.location.street = trim(this.booking.location.street);
              this.booking.location.house_number = trim(
                this.booking.location.house_number,
              );
              this.booking.location.zip_code = trim(
                this.booking.location.zip_code,
              );
              this.booking.location.place = trim(this.booking.location.place);
              this.booking.present_location = trim(
                this.booking.present_location,
              );

              // Check if required fields filled
              if (!isFilled(this.booking.location.street)) {
                this.validationMessages["booking.location.street"] = [
                  "Eingabe ist erforderlich.",
                ];
              }
              if (!isFilled(this.booking.location.house_number)) {
                this.validationMessages["booking.location.house_number"] = [
                  "Eingabe ist erforderlich.",
                ];
              }
              if (!isFilled(this.booking.location.zip_code)) {
                this.validationMessages["booking.location.zip_code"] = [
                  "Eingabe ist erforderlich.",
                ];
              }
              if (!isFilled(this.booking.location.place)) {
                this.validationMessages["booking.location.place"] = [
                  "Eingabe ist erforderlich.",
                ];
              }

              // Exit on validation errors
              if (Object.keys(this.validationMessages).length) {
                return;
              }

              const response = await sendRequest({
                url: `/api/bookings/${this.bookingId}`,
                method: "PUT",
                body: {
                  data: {
                    location: this.booking.location,
                    present_location: this.booking.present_location,
                  },
                },
              });

              this.isLoading = false;
              await this.init();
              await this.setStep(2);
            } catch (error) {
              console.error(error);
              this.error = error;
              this.errorToValidationMessages(error.body);
            } finally {
              this.isLoading = false;
            }
          },

          // Step 2: Fetch available time-slots
          async fetchTimeSlots(forceWhileLoading = false) {
            if (this.isLoading && !forceWhileLoading) {
              return;
            }
            const oldIsLoading = this.isLoading;
            this.isLoading = true;
            this.error = null;
            try {
              const response = await sendRequest({
                url: "/api/time-slots",
              });

              if (!response || !response.data) {
                throw new Error("No time-slots available");
              }

              // Map available time slots to a more usable format
              this.availableTimeSlots = response.data.map((slot) => ({
                id: slot.documentId,
                label: formatDateTimeRange(
                  new Date(slot.start),
                  new Date(slot.end),
                ),
                start: new Date(slot.start),
                end: new Date(slot.end),
                max_bookings: slot.max_bookings,
                max_reservations: slot.max_reservations,
                available_reservations: slot.available_reservations,
                isSelected: false,
              }));

              // Sort available time slots by start time
              this.availableTimeSlots.sort((a, b) => a.start - b.start);

              // Group available time slots by date
              this.groupedTimeSlotIds = this.availableTimeSlots.reduce(
                (acc, slot) => {
                  const date = formatTimeSlotGroup(slot.start);
                  acc[date] = acc[date] || [];
                  acc[date].push(slot.id);
                  return acc;
                },
                {},
              );

              // Set selected time-slots based on the booking object
              this.selectedTimeSlotIds = this.availableTimeSlots
                .filter((slot) =>
                  this.booking.time_slots.some(
                    (s) => s === slot.id || s.documentId === slot.id,
                  ),
                )
                .map((slot) => slot.id);
              this.availableTimeSlots.forEach((slot) => {
                slot.isSelected = this.selectedTimeSlotIds.includes(slot.id);
                slot.available_reservations += slot.isSelected ? 1 : 0;
              });

              this.isLoading = oldIsLoading;
            } catch (error) {
              console.error(error);
              this.isLoading = oldIsLoading;
              if (error && typeof error === "object") {
                this.error = {
                  message: error.message || "Failed to fetch time-slots",
                  status: error.status,
                  body: error.body,
                };
              } else {
                this.error = {
                  message: error || "Failed to fetch time-slots",
                };
              }
            }
          },

          // Step 2: Submit Time-Slot Selection
          async submitTimeSlots() {
            if (this.isLoading) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            this.validationMessages = {};
            try {
              // Clean input
              // (Nothing to do here)

              // Check if required fields filled
              // (Nothing to do here)

              // Exit on validation errors
              if (Object.keys(this.validationMessages).length) {
                return;
              }

              this.booking.time_slots = this.selectedTimeSlotIds;

              const response = await sendRequest({
                url: `/api/bookings/${this.bookingId}`,
                method: "PUT",
                body: {
                  data: {
                    time_slots: this.booking.time_slots,
                  },
                },
              });

              this.isLoading = false;
              await this.init();
              await this.setStep(3);
            } catch (error) {
              console.error(error);
              if (
                error.status.code === 409 /*Conflict*/ &&
                error.body?.error?.details?.meta?.concurrencyTimeSlotsError
              ) {
                this.error = {
                  ...error,
                  message:
                    error.body.error.message +
                    " " +
                    "Bitte wähle noch andere Zeitslots aus.",
                };
                this.errorCloseCallback = async () => await this.init();
              } else {
                this.error = error;
                this.errorToValidationMessages(error.body);
              }
            } finally {
              this.isLoading = false;
            }
          },

          // Toggle time-slot selection
          updateTimeSlot(slotId, isSelected = null) {
            const slot = this.availableTimeSlots.find((s) => s.id === slotId);
            if (isSelected !== null) {
              slot.isSelected = isSelected;
            }
            if (
              slot.isSelected &&
              !this.selectedTimeSlotIds.includes(slot.id)
            ) {
              this.selectedTimeSlotIds.push(slot.id);
              this.selectedTimeSlotIds.sort((a, b) => {
                const slotA = this.availableTimeSlots.find((s) => s.id === a);
                const slotB = this.availableTimeSlots.find((s) => s.id === b);
                return new Date(slotA.start) - new Date(slotB.start);
              });
            } else if (
              !slot.isSelected &&
              this.selectedTimeSlotIds.includes(slot.id)
            ) {
              this.selectedTimeSlotIds = this.selectedTimeSlotIds.filter(
                (sId) => sId !== slotId,
              );
            }
          },

          addChild() {
            this.booking.children.push({
              name: "",
              identification_trait: "",
              speech: "",
            });
          },

          removeChild(index) {
            if (confirm("Möchten Sie dieses Kind wirklich entfernen?")) {
              this.booking.children.splice(index, 1);
            }
          },

          // Step 3: Submit Children Details
          async submitChildren() {
            if (this.isLoading) {
              return;
            }
            this.isLoading = true;
            this.error = null;
            this.validationMessages = {};
            try {
              // Clean input
              for (const child of this.booking.children) {
                child.name = trim(child.name);
                child.identification_trait = trim(child.identification_trait);
                child.speech = trim(child.speech);
              }
              this.booking.additional_notes = trim(
                this.booking.additional_notes,
              );

              // Check if required fields filled
              this.booking.children.forEach((child, index) => {
                if (!isFilled(child.name)) {
                  this.validationMessages[`booking.children[${index}].name`] = [
                    "Eingabe ist erforderlich.",
                  ];
                }
              });

              // Exit on validation errors
              if (Object.keys(this.validationMessages).length) {
                return;
              }

              const children = this.booking.children.map((child) => ({
                name: child.name,
                identification_trait: child.identification_trait,
                speech: child.speech,
              }));

              const response = await sendRequest({
                url: `/api/bookings/${this.bookingId}`,
                method: "PUT",
                body: {
                  data: {
                    children: children,
                    additional_notes: this.booking.additional_notes,
                  },
                },
              });

              this.isLoading = false;
              await this.init();
              await this.setStep(4);
            } catch (error) {
              console.error(error);
              this.error = error;
              this.errorToValidationMessages(error.body);
            } finally {
              this.isLoading = false;
            }
          },
        }));
      });
    </script>
  </body>
</html>
